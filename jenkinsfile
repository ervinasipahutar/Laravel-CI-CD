pipeline {
    agent any

    environment {
        DOCKER_IMAGE_NAME = "royalnavy/laravel-image"
        DOCKER_IMAGE_TAG = "v${BUILD_NUMBER}"
        FILE_NAME = "laravel"
        DOCKER_HUB = "b2ff3deb-afa2-4d83-9867-cd72fdee776d"
        OC_TOKEN = "8c766c2b-dc0d-47e9-900e-fa41c6d57792"
    }
    
    stages {
        
        stage ('Checkout') {
            steps {
                git branch: 'master', url: 'https://github.com/muhamadilhamh/Laravel-CI-CD.git'
            }
        }

        stage ('Build Docker Image') {
            steps {
                sh "docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ."
            }
        }
        
      stage('push docker image'){
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: "${DOCKER_HUB}", passwordVariable: 'DOCKER_PASS', usernameVariable: 'DOCKER_USER')]) {
                        // Perintah docker login menggunakan variabel dari kredensial
                        sh "docker login -u $DOCKER_USER -p $DOCKER_PASS"
                        // Kemudian push image
                        sh "docker push ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
                        // Opsional: Logout setelah push selesai untuk keamanan
                        sh "docker logout"
                    }
                }
            }
        }
        
        stage ('Deploy via OpenShift') {
            steps {
                withCredentials([string(credentialsId:"${OC_TOKEN}" , variable: 'TOKEN')])
                echo 'Deploying application on target server via OpenShift...'
                sh "oc login --token=$TOKEN --server=https://api.rm1.0a51.p1.openshiftapps.com:6443"
                sh "sed -i 's|image: .*|image: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}|g' ${FILE_NAME}.yml"
                sh "oc apply -f ${FILE_NAME}.yml"
            }
        }
    }
    
    post {
        success {
            echo 'Application deployed successfully! ✅'
        }
        failure {
            echo 'Deployment failed. Please check the logs. ❌'
        }
    }
}